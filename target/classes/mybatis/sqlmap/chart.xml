<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.i4unetworks.weys.chart.ChartDao">
	
	<!-- 직거래 차트 현황  -->
	<select id="selectTradeList" resultType="chartBSVO">
		/* selectTradeList */
		SELECT
			T.TRADE_UNIT unit
			, COUNT(*) totalCnt
			, SUM(CASE WHEN T.TRADE_TP = 'B' THEN 1 ELSE 0 END) BUY_CNT
			, SUM(CASE WHEN T.TRADE_TP = 'B' THEN T.TRADE_AMNT ELSE 0 END) BUY_SUM
			, SUM(CASE WHEN T.TRADE_TP = 'B' AND T.TRADE_UNIT = 'JPY' THEN CAST(T.TRADE_AMNT * E.BASIC_RATE / 100 AS INT) 
					WHEN T.TRADE_TP = 'B' THEN CAST(T.TRADE_AMNT * E.BASIC_RATE AS INT) ELSE 0 END) BUY_KOR
			, SUM(CASE WHEN T.TRADE_TP = 'S' THEN 1 ELSE 0 END) SELL_CNT
			, SUM(CASE WHEN T.TRADE_TP = 'S' THEN T.TRADE_AMNT ELSE 0 END) SELL_SUM
			, SUM(CASE WHEN T.TRADE_TP = 'S' AND T.TRADE_UNIT = 'JPY' THEN CAST(T.TRADE_AMNT * E.BASIC_RATE / 100 AS INT) 
					WHEN T.TRADE_TP = 'S' THEN CAST(T.TRADE_AMNT * E.BASIC_RATE AS INT) ELSE 0 END) SELL_KOR
			, IFNULL(U.UNIT_DP, '') UNIT_DP
		FROM TRADE T
		LEFT OUTER JOIN (
			SELECT
				UNIT
				, BASIC_RATE
			FROM EXCHANGE_RATE
			WHERE DTTM =(
			SELECT MAX(DTTM) FROM EXCHANGE_RATE)
		) E ON T.TRADE_UNIT = E.UNIT
		LEFT OUTER JOIN (
			SELECT
				UNIT_CD
				, UNIT_DP
			FROM UNIT
		) U ON T.TRADE_UNIT = U.UNIT_CD
		GROUP BY T.TRADE_UNIT
		ORDER BY totalCnt DESC
	</select>
	
	<!-- 직거래 월별 등록 현황  -->
	<select id="selectTradeMonthlyData" resultType="chartUnitVO">
		/* selectTradeMonthlyData */
		SELECT 
			SUM(CASE WHEN TRADE_UNIT = 'USD' THEN 1 ELSE 0 END) USD_CNT
			, SUM(CASE WHEN TRADE_UNIT = 'JPY' THEN 1 ELSE 0 END) JPY_CNT
			, SUM(CASE WHEN TRADE_UNIT = 'EUR' THEN 1 ELSE 0 END) EUR_CNT
			, SUM(CASE WHEN TRADE_UNIT = 'CNY' THEN 1 ELSE 0 END) CNY_CNT
			, SUM(CASE WHEN TRADE_UNIT NOT IN ('USD', 'JPY', 'EUR', 'CNY') THEN 1 ELSE 0 END) OTHER_CNT
			, CONCAT('"', DATE_FORMAT(TRADE_REG_DTTM, '%y.%m'), '"') dt
		FROM TRADE
		WHERE TRADE_REG_DTTM &gt; #{value}
		GROUP BY dt
		ORDER BY dt DESC
	</select>
	
	<!-- 환전소 거래 현황  -->
	<select id="selectExcList" resultType="chartBSVO">
		/* selectExcList */
		SELECT
			M.UNIT unit
			, COUNT(*) totalCnt
			, SUM(CASE WHEN M.TP = 'B' THEN 1 ELSE 0 END) BUY_CNT
			, SUM(CASE WHEN M.TP = 'B' THEN M.PAY_AMNT ELSE 0 END) BUY_SUM
			, SUM(CASE WHEN M.TP = 'B' THEN M.GET_AMNT ELSE 0 END) BUY_KOR
			, SUM(CASE WHEN M.TP = 'S' THEN 1 ELSE 0 END) SELL_CNT
			, SUM(CASE WHEN M.TP = 'S' THEN M.GET_AMNT ELSE 0 END) SELL_SUM
			, SUM(CASE WHEN M.TP = 'S' THEN M.PAY_AMNT ELSE 0 END) SELL_KOR
			, U.UNIT_DP
		FROM MEMBER_ACTIVE M, UNIT U
		WHERE M.TP IN ('B' , 'S')
			AND M.UNIT = U.UNIT_CD
		GROUP BY M.UNIT
		ORDER BY totalCnt DESC
	</select>

	<!-- 환전소 월별 거래 현황  -->
	<select id="selectExcMonthlyData" resultType="chartUnitVO">
		/* selectExcMonthlyData */
		SELECT 
			SUM(CASE WHEN UNIT = 'USD' THEN 1 ELSE 0 END) USD_CNT
			, SUM(CASE WHEN UNIT = 'JPY' THEN 1 ELSE 0 END) JPY_CNT
			, SUM(CASE WHEN UNIT = 'EUR' THEN 1 ELSE 0 END) EUR_CNT
			, SUM(CASE WHEN UNIT = 'CNY' THEN 1 ELSE 0 END) CNY_CNT
			, CONCAT('"', DATE_FORMAT(REG_DTTM, '%y.%m'), '"') dt
		FROM MEMBER_ACTIVE
		WHERE REG_DTTM &gt; #{value}
			AND TP IN ('B' , 'S')
		GROUP BY dt
		ORDER BY dt DESC
	</select>
	
	<!-- 직거래 주별 등록 현황  -->
	<select id="selectTradeWeeklyData" resultType="chartUnitVO">
		/* selectTradeWeeklyData */
		SELECT 
			IFNULL(COUNT(*), 0) totalCnt	
			, IFNULL(SUM(CASE WHEN TRADE_UNIT = 'USD' THEN 1 ELSE 0 END), 0) USD_CNT			
			, IFNULL(SUM(CASE WHEN TRADE_UNIT = 'USD' THEN CAST(T.TRADE_AMNT * E.BASIC_RATE AS INT) ELSE 0 END), 0) USD_SUM		
			, IFNULL(SUM(CASE WHEN TRADE_UNIT = 'JPY' THEN 1 ELSE 0 END), 0) JPY_CNT
			, IFNULL(SUM(CASE WHEN TRADE_UNIT = 'JPY' THEN CAST(T.TRADE_AMNT * E.BASIC_RATE / 100 AS INT) ELSE 0 END), 0) JPY_SUM	
			, IFNULL(SUM(CASE WHEN TRADE_UNIT = 'EUR' THEN 1 ELSE 0 END), 0) EUR_CNT
			, IFNULL(SUM(CASE WHEN TRADE_UNIT = 'EUR' THEN CAST(T.TRADE_AMNT * E.BASIC_RATE AS INT) ELSE 0 END), 0) EUR_SUM	
			, IFNULL(SUM(CASE WHEN TRADE_UNIT = 'CNY' THEN 1 ELSE 0 END), 0) CNY_CNT
			, IFNULL(SUM(CASE WHEN TRADE_UNIT = 'CNY' THEN CAST(T.TRADE_AMNT * E.BASIC_RATE AS INT) ELSE 0 END), 0) CNY_SUM	
			, IFNULL(SUM(CASE WHEN TRADE_UNIT NOT IN ('USD', 'JPY', 'EUR', 'CNY') THEN 1 ELSE 0 END), 0) OTHER_CNT
			, IFNULL(SUM(CASE WHEN TRADE_UNIT NOT IN ('USD', 'JPY', 'EUR', 'CNY') THEN CAST(T.TRADE_AMNT * E.BASIC_RATE AS INT) ELSE 0 END), 0) OTHER_SUM	
		FROM TRADE T
		LEFT OUTER JOIN (
			SELECT
				UNIT
				, BASIC_RATE
			FROM EXCHANGE_RATE
			WHERE DTTM =(
			SELECT MAX(DTTM) FROM EXCHANGE_RATE)
		) E ON T.TRADE_UNIT = E.UNIT
		WHERE TRADE_REG_DTTM BETWEEN #{startDt} AND CONCAT(#{endDt}, ' 23:59:59')
	</select>
	
	<!-- 환전 주별 거래 현황  -->
	<select id="selectExcWeeklyData" resultType="chartUnitVO">
		/* selectExcWeeklyData */
		SELECT
			SUM(CASE WHEN UNIT = 'USD' THEN 1 ELSE 0 END) USD_CNT
			, SUM(CASE WHEN UNIT = 'USD' AND TP='B' THEN GET_AMNT WHEN UNIT = 'USD' AND TP='S' THEN PAY_AMNT ELSE 0 END) USD_SUM
			, SUM(CASE WHEN UNIT = 'JPY' THEN 1 ELSE 0 END) JPY_CNT
			, SUM(CASE WHEN UNIT = 'JPY' AND TP='B' THEN GET_AMNT WHEN UNIT = 'JPY' AND TP='S' THEN PAY_AMNT ELSE 0 END) JPY_SUM
			, SUM(CASE WHEN UNIT = 'EUR' THEN 1 ELSE 0 END) EUR_CNT
			, SUM(CASE WHEN UNIT = 'EUR' AND TP='B' THEN GET_AMNT WHEN UNIT = 'EUR' AND TP='S' THEN PAY_AMNT ELSE 0 END) EUR_SUM
			, SUM(CASE WHEN UNIT = 'CNY' THEN 1 ELSE 0 END) CNY_CNT
			, SUM(CASE WHEN UNIT = 'CNY' AND TP='B' THEN GET_AMNT WHEN UNIT = 'CNY' AND TP='S' THEN PAY_AMNT ELSE 0 END) CNY_SUM
		FROM MEMBER_ACTIVE T
		WHERE TP IN ('B', 'S')
			AND REG_DTTM BETWEEN #{startDt} AND CONCAT(#{endDt}, ' 23:59:59')
	</select>
	
	<!-- 화폐별 환전 거래량  -->
	<select id="selectExcBarChart" resultType="map">
		/* selectExcBarChart */
		SELECT
			M.UNIT UNIT
			, SUM(CASE WHEN M.TP = 'B' AND MEMBER_ID IS NULL THEN M.GET_AMNT ELSE 0 END) BUY_KOR_NOMEM
			, SUM(CASE WHEN M.TP = 'B' AND MEMBER_ID IS NOT NULL THEN M.GET_AMNT ELSE 0 END) BUY_KOR_MEM
			, SUM(CASE WHEN M.TP = 'S' AND MEMBER_ID IS NULL THEN M.PAY_AMNT ELSE 0 END) SELL_KOR_NOMEM		
			, SUM(CASE WHEN M.TP = 'S' AND MEMBER_ID IS NOT NULL THEN M.PAY_AMNT ELSE 0 END) SELL_KOR_MEM		
		FROM MEMBER_ACTIVE M, UNIT U
		WHERE M.TP IN ('B' , 'S')
			AND M.UNIT = U.UNIT_CD
		GROUP BY M.UNIT
		ORDER BY U.UNIT_ID
	</select>
	
</mapper>